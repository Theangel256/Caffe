---
import db from "../../utils/db.js";
import Header from "../components/_head.astro";
import Dashboard from "../components/dashboardNavbar.astro";
const levels = require("../../../utils/models/levels");
const database = await db();
const bot = Astro.locals.bot;
// Fetch top 10 users by XP from the database
const users = await database.collection("users").find().sort({ xp: -1 }).limit(10).toArray();

function getRank(leaderboard) {
  const userlist = [];
  for (const key of leaderboard) {
    userlist.push([key.userID, key.lvl, key.xp]);
  }

  userlist.sort((user1, user2) => {
    return user2[1] - user1[1] || user2[2] - user1[2];
  });
  return userlist;
}
const usuarios = getRank(await levels.find({ guildID: idserver })),
---

<html>
  <body>
    <h1>Leaderboard</h1>
    <ul>
      {users.map(u => <li>{u.username} â€” {u.xp} XP</li>)}
    </ul>
  </body>
</html>

<!DOCTYPE html>
<html lang="es">
  <head>
    <link rel="stylesheet" type="text/css" href="/leaderboard.css" />
    <Header title="Caffe - Leaderboard" />
  </head>
  <body>
    <Dashboard></Dashboard>
    <div id="section-leaderboard" class="container leaderPlayerList">
      <h2>Lista de usuarios</h2>
      {
      users.map((usuario, index) => {
      <div>
        <div class="leaderPlayer">
          <div
            class={`leaderRank ${users.findIndex(u=> u[0] === usuario[0])+1 === 1
            ? 'leaderFirstRank'
            : users.findIndex(u =>u[0]===usuario[0])+1===2
            ? 'leaderSecondRank'
            : users.findIndex(u => u[0] === usuario[0])+1 === 3
            ? 'leaderThirdRank' : null}`}>
            {users.findIndex(u => u[0] === usuario[0])+1}
          </div>
          <div class="leaderAvatar">
            <img
              src={bot.users.cache.get(usuario[0]).displayAvatarURL({ extension: 'png' })}
              alt={bot.users.cache.get(usuario[0]).username}
            />
          </div>
          <div class="leaderUsername">
            {bot.users.resolve(usuario[0]).username}
          </div>
        </div>
        <div class="leaderLine"></div>
      </div>
      })
    </div>
  </body>
</html>
