---
import Header from '../components/_head.astro';
import Navbar from '../components/navbar.astro';

// Type definition for user (matching your env.d.ts and middleware)
interface DiscordUser {
  id: string;
  username: string;
  avatar: string;
  guilds?: Array<{
    id: string;
    name: string;
    permissions: number;
    icon?: string; // Optional icon field
  }>;
  accessToken?: string;
}

// Access user from locals (set by middleware)
const user = Astro.locals.user as DiscordUser | undefined;
if (!user) {
  return Astro.redirect('/api/signin'); // Double security in frontmatter
}

// Fetch guilds dynamically since they're not in the session
let guilds: Array<{
  id: string;
  name: string;
  permissions: number;
  icon?: string;
}> = [];
if (user.accessToken) {
  const guildsRes = await fetch('https://discord.com/api/users/@me/guilds', {
    headers: { Authorization: `Bearer ${user.accessToken}` },
  });
  if (guildsRes.ok) {
    guilds = await guildsRes.json() as Array<{
      id: string;
      name: string;
      permissions: number;
      icon?: string;
    }>;
  }
}
const adminGuilds = guilds.filter(g => (g.permissions & 8) === 8) || [];
---

<!DOCTYPE html>
<html lang="es">
  <head>
    <Header title="Caffe - Dashboard" />
  </head>
  <body class="body-index">
    <Navbar guild={adminGuilds[0]} user={user} />
    <center>
      <div class="user-info">
        <h2>Welcome back, {user.username}!</h2>
        <img
          src={`https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`}
          alt={user.username}
        />
      </div>
      <div class="container-fluid">
        <section class="body-header">
          <h1><b>PLEASE SELECT A SERVER</b></h1><br />

          {adminGuilds.length > 0 ? (
            adminGuilds.map(dato => (
              <a
                class="navbar-brand"
                data-toggle="tooltip"
                data-placement="bottom"
                title={dato.name}
                href={`/dashboard/${dato.id}`}
              >
                {dato.icon ? (
                  <img
                    class="Server-select responsive-img"
                    src={`https://cdn.discordapp.com/icons/${dato.id}/${dato.icon}.png`}
                    alt={dato.name}
                    onerror="this.src='https://discordapp.com/assets/6debd47ed13483642cf09e832ed0bc1b.png';"
                  />
                ) : (
                  <img
                    class="Server-select responsive-img"
                    src="https://discordapp.com/assets/6debd47ed13483642cf09e832ed0bc1b.png"
                    alt={dato.name}
                  />
                )}
              </a>
            ))
          ) : (
            <p>No admin guilds available.</p>
          )}
        </section>
      </div>
    </center>
  </body>
</html>

<script src="/js/tooltip.js" is:inline></script>