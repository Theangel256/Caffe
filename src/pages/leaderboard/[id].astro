---
export const prerender = false; // No generar estático

import Head from "../../components/_head.astro";

// Type definitions
interface GuildData {
  id: string;
  name: string;
}

interface LeaderboardUser {
  id: string;
  name: string;
  avatar: string;
  lvl: number;
  xp: number;
}

interface LeaderboardResponse {
  guild: GuildData;
  users: LeaderboardUser[];
}

interface DiscordUser {
  id: string;
  username: string;
  avatar: string;
  guilds?: Array<{
    id: string;
    name: string;
    permissions: number;
    icon?: string; // Optional icon field
  }>;
  accessToken?: string;
}

// Get dynamic ID parameter and base URL
const { id } = Astro.params;
const baseUrl = Astro.url.origin;

// Authentication and data fetching
const user = Astro.locals.user as DiscordUser | undefined;
if (!user) return Astro.redirect("/api/signin");

let data: LeaderboardResponse | undefined = undefined;
let fetchError: string | undefined = undefined;

try {
  const res = await fetch(`${baseUrl}/api/leaderboard/${id}`, {
    headers: {
      Authorization: `Bearer ${user.accessToken}`,
      'Content-Type': 'application/json',
    },
  });

  if (!res.ok) {
    const text = await res.text();
    throw new Error(`HTTP ${res.status} - ${res.statusText}${text ? `: ${text}` : ''}`);
  }

  data = await res.json();
} catch (err: any) {
  console.error('[Leaderboard] fetch failed:', err);
  fetchError = err.message;
}
const { guild = { id, name: 'Unknown Guild' }, users = [] } = data ?? {};
---
<head>
  <Head title={`Leaderboard - ${guild.name}`} />
  <style>
      body {
        background: #0d1117;
        color: #fff;
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 2rem;
      }
      h1 {
        text-align: center;
        margin-bottom: 2rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 10px;
        overflow: hidden;
        background-color: #161b22;
      }
      th, td {
        padding: 1rem;
        text-align: left;
      }
      th {
        background-color: #21262d;
        color: #c9d1d9;
      }
      tr:nth-child(even) {
        background-color: #1e2329;
      }
      img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        vertical-align: middle;
        margin-right: 10px;
      }
      .user {
        display: flex;
        align-items: center;
      }
      .rank {
        font-weight: bold;
        color: #58a6ff;
      }
    </style>
</head>
<main class="container mx-auto p-4 max-w-4xl">
  <h1 class="text-3xl font-bold mb-2">
    Leaderboard - {guild.name}
    <span class="text-sm font-normal text-gray-500">#{guild.id}</span>
  </h1>

  {fetchError ? (
    <div class="bg-red-50 border border-red-200 text-red-700 p-4 rounded mb-6">
      <strong>Failed to load leaderboard:</strong> {fetchError}
      <br />
      <a href="/leaderboard" class="underline">← Back to leaderboard</a>
    </div>
  ) : null}

  {users.length > 0 ? (
    <div class="overflow-x-auto shadow-md rounded-lg">
      <table class="min-w-full bg-white">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="px-4 py-3 text-left">#</th>
            <th class="px-4 py-3 text-left">User</th>
            <th class="px-4 py-3 text-center">Level</th>
            <th class="px-4 py-3 text-center">XP</th>
          </tr>
        </thead>
        <tbody class="text-gray-800">
          {users.map((u, i) => (
            <tr class="border-b hover:bg-gray-50">
              <td class="px-4 py-3 font-medium">#{i + 1}</td>
              <td class="px-4 py-3 flex items-center gap-3">
                <img
                  src={
                    u.avatar
                      ? `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.webp?size=40`
                      : `https://cdn.discordapp.com/embed/avatars/${Number(u.id) % 5}.png`
                  }
                  alt={u.name}
                  class="w-10 h-10 rounded-full"
                  loading="lazy"
                />
                <span class="font-medium">{u.name}</span>
              </td>
              <td class="px-4 py-3 text-center">{u.lvl}</td>
              <td class="px-4 py-3 text-center">{u.xp.toLocaleString()}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  ) : (
    <p class="text-gray-600 italic">No users on the leaderboard yet.</p>
  )}
</main>