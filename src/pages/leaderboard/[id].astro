---
export const prerender = false; // No generar estático

import Head from "../../components/_head.astro";

// Type definitions
interface GuildData {
  id: string;
  name: string;
}

interface LeaderboardUser {
  id: string;
  name: string;
  avatar: string;
  lvl: number;
  xp: number;
}

interface LeaderboardResponse {
  guild: GuildData;
  users: LeaderboardUser[];
}

interface DiscordUser {
  id: string;
  username: string;
  avatar: string;
  guilds?: Array<{
    id: string;
    name: string;
    permissions: number;
    icon?: string; // Optional icon field
  }>;
  accessToken?: string;
}

// Get dynamic ID parameter and base URL
const { id } = Astro.params;
const baseUrl = Astro.url.origin;

// Authentication and data fetching
const user = Astro.locals.user as DiscordUser | undefined;
if (!user) return Astro.redirect("/api/signin");

let data: LeaderboardResponse | undefined = undefined;
let fetchError: string | undefined = undefined;

try {
  const res = await fetch(`${baseUrl}/api/leaderboard/${id}`, {
    headers: {
      Authorization: `Bearer ${user.accessToken}`,
      'Content-Type': 'application/json',
    },
  });

  if (!res.ok) {
    const text = await res.text();
    throw new Error(`HTTP ${res.status} - ${res.statusText}${text ? `: ${text}` : ''}`);
  }

  data = await res.json();
} catch (err: any) {
  console.error('[Leaderboard] fetch failed:', err);
  fetchError = err.message;
}
const { guild = { id, name: 'Unknown Guild' }, users = [] } = data ?? {};
---
<head>
  <Head title={`Leaderboard - ${guild.name}`} />
  <link rel="stylesheet" href="/css/leaderboard.css" />
</head>
<main class="container mx-auto p-4 max-w-4xl">
<div class="container">
  <h1>Leaderboard - {guild.name} <small>#{guild.id}</small></h1>
  <div class="table-container">
  {fetchError ? (
    <div class="bg-red-50 border border-red-200 text-red-700 p-4 rounded mb-6">
      <strong>Failed to load leaderboard:</strong> {fetchError}
      <br />
      <a href="/leaderboard" class="underline">← Back to leaderboard</a>
    </div>
  ) : null}
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>User</th>
          <th>Level</th>
          <th>XP</th>
        </tr>
      </thead>
      <tbody>
        {users.map((u, i) => (
          <tr>
            <td>{i + 1}</td>
            <td class="user-cell">
              <img
                src={u.avatar
                  ? `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.webp?size=40`
                  : `https://cdn.discordapp.com/embed/avatars/${Number(u.id) % 5}.png`
                }
                alt={u.name}
                class="user-avatar"
              />
              <span class="user-name">{u.name}</span>
            </td>
            <td class="level">{u.lvl}</td>
            <td class="xp">{u.xp.toLocaleString()}</td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>

  {users.length === 0 && <p style="text-align: center; margin-top: 2rem; opacity: 0.7;">No hay usuarios en el leaderboard aún.</p>}
</div>
</main>