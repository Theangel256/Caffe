services:
  - type: web
    name: caffe-bot-astro
    env: node
    region: oregon
    plan: starter

    buildCommand: npm install && npx astro build

    startCommand: |
      node dist/server/entry.mjs & node -e "
        const { ShardingManager } = require('discord.js');
        const manager = new ShardingManager('./src/shard.js', {
          token: process.env.DISCORD_TOKEN,
          totalShards: 'auto',
          shardArgs: ['--max-old-space-size=2048']
        });
        manager.spawn();
        manager.on('shardCreate', shard => {
          console.log(\`Shard \${shard.id} creado\`);
          shard.on('ready', () => console.log(\`Shard \${shard.id} listo\`));
          shard.on('death', () => console.log(\`Shard \${shard.id} muri√≥\`, shard));
        });
      "

    envVars:
      NODE_VERSION: "20.17.0"
      PORT: "10000"

    healthCheckPath: /api/health
    autoDeploy: true